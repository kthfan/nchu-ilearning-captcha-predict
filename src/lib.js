
const WEIGHTS = [[[[[0.48465362191200256]], [[0.9434792995452881]], [[0.12599800527095795]], [[-0.26033398509025574]], [[-0.6629212498664856]]], [[[0.7020631432533264]], [[0.9853082895278931]], [[-0.2520603835582733]], [[-0.10358437895774841]], [[-0.31299418210983276]]], [[[0.17368122935295105]], [[0.39303597807884216]], [[0.09989382326602936]], [[0.3771859407424927]], [[0.008574776351451874]]], [[[0.5528414845466614]], [[0.9854571223258972]], [[0.928545355796814]], [[1.003617763519287]], [[0.515132486820221]]], [[[-0.15321584045886993]], [[0.8506987690925598]], [[1.1369074583053589]], [[0.950276792049408]], [[-0.04798683896660805]]]], [-0.47387152910232544], [[0.2808271646499634], [-0.07162200659513474], [-0.43567875027656555], [-0.05466209352016449], [-0.06413307040929794], [0.20974670350551605], [0.31433117389678955], [-0.4764496088027954], [0.16882804036140442], [0.31772881746292114], [0.2122052013874054], [-0.07200957834720612], [-0.10323166102170944], [0.27491918206214905], [0.4880877137184143], [0.014306925237178802], [-0.03887822851538658], [0.5572260022163391], [0.26441505551338196], [-0.3640051484107971], [0.2506062984466553], [0.17514149844646454], [-0.23148362338542938], [0.32756301760673523], [0.40187162160873413], [0.22789061069488525], [0.3879113495349884], [-0.42806243896484375], [-0.1644185483455658], [-0.01759129762649536], [0.41663262248039246], [0.2726278603076935], [-0.30853399634361267], [-0.8266347050666809], [0.38550078868865967], [0.46803876757621765]], [-0.13923989236354828], [[0.07855242490768433], [0.25547823309898376], [0.2595844268798828], [0.2340375930070877], [-0.3374941945075989], [0.21461428701877594], [0.604753851890564], [0.14441591501235962], [-0.29912081360816956], [0.6893749237060547], [0.21737386286258698], [0.17601235210895538], [0.21719256043434143], [0.6355969905853271], [-0.5525043606758118], [-0.41418173909187317], [0.3242509067058563], [-0.3851785361766815], [0.34024468064308167], [-0.14330659806728363], [0.600072979927063], [-0.4804925322532654], [-0.4600033760070801], [-0.3574107587337494], [-0.2362184077501297], [-0.4497687816619873], [-0.47949686646461487], [0.554236650466919], [-0.025001447647809982], [0.08088988810777664], [-0.21431627869606018], [0.27262452244758606], [0.13855548202991486], [-0.4076240062713623], [0.1653902232646942], [-0.20846760272979736]], [-0.011698118411004543], [[-0.11077132076025009], [-0.8066920638084412], [0.1834331899881363], [0.11619459092617035], [-0.41423434019088745], [-0.2479635775089264], [-0.6760014295578003], [-0.7087044715881348], [-0.07310593873262405], [0.25394490361213684], [-0.423814594745636], [-0.020981846377253532], [-0.7960299253463745], [-0.35327738523483276], [-0.08179852366447449], [0.10776849836111069], [-0.2520607113838196], [-0.5628595948219299], [-0.3974757790565491], [0.13101546466350555], [0.21125859022140503], [0.4004318118095398], [-0.541029691696167], [-0.14913153648376465], [-0.1572771966457367], [-0.4073263704776764], [-0.1919720470905304], [0.6299015283584595], [-0.40733131766319275], [-0.4423994719982147], [-0.7312098145484924], [0.05642437934875488], [-0.10185115039348602], [-0.34470751881599426], [0.25663450360298157], [-0.4396871030330658]], [0.25538793206214905], [[0.026728466153144836], [-0.8521753549575806], [-0.08063016831874847], [-0.1879138946533203], [-0.05914552882313728], [-0.023576991632580757], [0.02248336561024189], [-0.07880265265703201], [-0.12169378995895386], [0.04592837393283844], [0.04875516518950462], [0.5047531127929688], [-0.3354170024394989], [0.8409783244132996], [0.32137078046798706], [0.19380933046340942], [-0.05346226319670677], [0.1243879646062851], [0.0825127586722374], [0.5705686807632446], [0.5892252922058105], [0.12394700199365616], [0.37506023049354553], [-0.17963899672031403], [0.3776684105396271], [-0.264163076877594], [-0.638634204864502], [-0.03794291988015175], [-0.5384745597839355], [-0.13639509677886963], [-0.04237975925207138], [-0.02123824693262577], [0.039820268750190735], [-0.12884201109409332], [-0.44670364260673523], [0.5599521398544312]], [-0.1177869439125061], [[-0.40724727511405945, -0.41595688462257385, -0.6809712052345276, -1.209894061088562, -0.4118603467941284, -0.38971075415611267, 0.5094611644744873, 0.616977334022522, 0.850294828414917, 0.4528067708015442], [0.0675683245062828, 0.2420661449432373, 1.0201348066329956, -0.2965118885040283, 0.83014315366745, -0.716244101524353, -0.6260841488838196, 0.7865102291107178, -0.4023395776748657, 0.8789560794830322], [0.5903205275535583, 1.0126560926437378, 0.1514458954334259, -0.28055986762046814, 0.8864985108375549, -0.4231315851211548, 0.7323207855224609, 0.6943830847740173, -0.45704492926597595, -0.3790554702281952], [-0.27121323347091675, 0.4800153970718384, -0.7501260042190552, -0.593634843826294, 0.8153342008590698, -0.38893789052963257, 0.7532566785812378, -0.5616769194602966, 0.05030263960361481, 0.64664626121521]], [-1.970189094543457, 0.28630948066711426, -0.17325815558433533, 0.19919678568840027, -0.24759884178638458, -0.3110189437866211, -0.11547639966011047, 0.08894068002700806, 0.24788306653499603, -0.004204208962619305]];

function load_js(src){
	let script = document.createElement("script");
	script.src = src;
	script.async = true;
	document.body.appendChild(script);
	let [ok, err] = [null, null]; 
	let promise = new Promise((resolve, reject) => {
		ok = resolve;
		err = reject;
	});
	// let timdId = setTimeout(()=>ok(), 5000); // wait for 5s.
	script.onload = () => {
		//clearTimeout(timdId);
		ok();
	}
	return promise;
}

function convertByColor(I){
	// let len = I.data.length;
	// for(let i=0; i<len; i+=4){
	// 	if(I.data[i] >= 170) I.data[i] = 255;
	// }
	// for(let i=1; i<len; i+=4){
	// 	if(I.data[i] >= 150) I.data[i] = 255;
	// }
	// for(let i=2; i<len; i+=4){
	// 	if(I.data[i] >= 150) I.data[i] = 255;
	// }
	cv.cvtColor(I, I, cv.COLOR_RGB2GRAY);
    cv.threshold(I, I, 100, 255, cv.THRESH_BINARY_INV);
    return I;
}

function splitImage(I){
	let tmp = I;
	I = tf.tensor(I.data, [I.rows, I.cols]);
	tmp.delete();
	I = tf.slice(I, [3, 11], [20, 79]);
	let [h, w] = I.shape;
	let w2 = Number.parseInt(w/6);
	let s = new cv.Scalar(0, 0, 0, 255);
	let result = Array.from(Array(6))
		.map((_, i) => tf.slice(I, [0, i*w2], [I.shape[0], w2]))
		.map(img => cv.matFromArray(img.shape[0], img.shape[1], cv.CV_8U, img.dataSync()))
		.map(img => (cv.copyMakeBorder(img, img, 4,4,7,8, cv.BORDER_CONSTANT, s), img));
	
	return result
}
function imagesToTensors(image_list){
	var result = image_list
		.map(img => tf.tensor(img.data, [1, img.rows, img.cols, 1]));
	image_list.forEach(img => img.delete());
	return tf.concat(result, 0);
}
function loadWeights(model, weights){
	weights = weights.map(w => tf.tensor(w));
	model.setWeights(weights);
}
function build_model(){


	let inputs = tf.input({shape:[28, 28, 1], name:'inputs'});
	
	let conv1 = tf.layers.conv2d({filters :1, kernelSize: 5, name:'conv1'}).apply(inputs);
	let pool1 = tf.layers.maxPool2d({poolSize :[4, 4], name:'pool1'}).apply(conv1);
	let flatten = tf.layers.flatten({name: "flatten"}).apply(pool1);
	let dense1 = tf.layers.dense({units:1, name:"dense1"}).apply(flatten);
	let dense2 = tf.layers.dense({units:1, name:"dense2"}).apply(flatten);
	let dense3 = tf.layers.dense({units:1, name:"dense3"}).apply(flatten);
	let dense4 = tf.layers.dense({units:1, name:"dense4"}).apply(flatten);
	let concat = tf.layers.concatenate({axis: 1, name:"concat"}).apply([dense1, dense2, dense3, dense4])
	let drop1 = tf.layers.dropout({rate: 0.2, name:"drop1"}).apply(concat);
	let outputs = tf.layers.dense({units: 10, activation: "softmax", name:"outputs"}).apply(drop1);

	let model = tf.model({inputs: inputs, outputs: outputs});
	
	// model.compile({optimizer: 'adam',loss: 'categoricalCrossentropy',metrics: ['accuracy']})
	// model.summary()
	return model;
}

function predict(model, imgElem){
	let I = cv.imread(imgElem);
	I = convertByColor(I);
	let images = splitImage(I);
	let tensors = imagesToTensors(images);
	let pY = model.predict(tensors);
	return pY.argMax(1).arraySync().join("");
}
